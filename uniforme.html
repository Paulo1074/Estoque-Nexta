<!doctype html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estoque Nexta - Uniformes</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="app">
        <aside class="sidebar">
            <div class="logo">
                <img src="img/nexta.jpg" alt="Logo Estoque Nexta" class="logo-img">
                <h1>Estoque Nexta</h1>
            </div>

            <div class="nav">
                <a href="index.html" class="btn-nav">Movimentações</a>
                <a href="uniforme.html" class="btn-nav active">Uniformes</a>
                <a href="Brindes.html" class="btn-nav">Materiais Marketing</a>
                <a href="EstoqueRoupas.html" class="btn-nav">Estoque Roupas</a>
                <a href="EstoqueMkt.html" class="btn-nav">Estoque Materiais</a>
            </div>
        </aside>

        <main class="main">
            <header>
                <h2>Cadastro de Uniformes</h2>
            </header>

            <section class="form-section">
                <h3>Adicionar novo uniforme</h3>
                <form id="uniformForm">
                    <select id="nomeUniforme" required>
                        <option value="">Selecione o uniforme</option>
                        <option value="Camisa Polo">Camisa Polo</option>
                        <option value="Camisa Social">Camisa Social</option>
                        <option value="Calça">Calça</option>
                        <option value="Jaqueta">Jaqueta</option>
                        <option value="Boné">Boné</option>
                    </select>

                    <input type="text" id="descricaoUniforme" placeholder="Descrição (opcional)">
                    <input type="text" id="remetenteUniforme" placeholder="Nome do Destinatário" required>
                    <input type="text" id="originUniforme" placeholder="Cidade de Origem (opcional)">
                    <input type="text" id="destinationUniforme" placeholder="Cidade de Destino (opcional)">
                    <input type="number" id="quantidadeMovimentada" placeholder="Qnt mov" min="0" value="0">
                    <input type="number" id="quantidadeFinal" placeholder="Qnt final" min="0" value="0">
                    <input type="text" id="custoUnitarioUniforme" placeholder="Custo unit">
                    <input type="text" id="custoTotalUniforme" placeholder="Custo total">

                    <div id="totalGeral" style="margin-top: 10px; font-weight: bold;"></div>

                    <select id="tipoUniforme" required>
                        <option value="entrada">Entrada</option>
                        <option value="saida">Saída</option>
                    </select>

                    <div class="sizes">
                        <label>PP <input type="number" id="pp" min="0" value="0"></label>
                        <label>P <input type="number" id="p" min="0" value="0"></label>
                        <label>M <input type="number" id="m" min="0" value="0"></label>
                        <label>G <input type="number" id="g" min="0" value="0"></label>
                        <label>GG <input type="number" id="gg" min="0" value="0"></label>
                        <label>XG <input type="number" id="xg" min="0" value="0"></label>
                        <label>XXG <input type="number" id="xxg" min="0" value="0"></label>
                    </div>

                    <button type="submit" class="btn primary">Salvar uniforme</button>
                    <button type="button" onclick="limparUniformes()" class="btn danger">Limpar Todos</button>
                </form>
            </section>

            <section class="list-section">
                <h3>Uniformes cadastrados</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Uniforme</th>
                            <th>Descrição</th>
                            <th>Remetente</th>
                            <th>Tipo</th>
                            <th>PP</th>
                            <th>P</th>
                            <th>M</th>
                            <th>G</th>
                            <th>GG</th>
                            <th>XG</th>
                            <th>XXG</th>
                            <th>Total</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaUniformes"></tbody>
                </table>
            </section>
        </main>
    </div>

    <!-- ===== SCRIPT ORIGINAL ===== -->
    <script>
        const form = document.getElementById("uniformForm");
        const tabela = document.getElementById("tabelaUniformes");
        const btnSalvar = form.querySelector("button[type='submit']");
        const selectUniforme = document.getElementById("nomeUniforme");

        let uniformes = JSON.parse(localStorage.getItem("uniformes")) || [];
        let editIndex = -1;

        const precosUniformes = {
            "Camisa Polo": 88.90,
            "Camisa Social": 107.80,
            "Calça": 94.60,
            "Jaqueta": 225.00,
            "Boné": 38.00,
        };

        function atualizarTabela() {
            tabela.innerHTML = "";
            uniformes.forEach((uni, index) => {
                const total = uni.pp + uni.p + uni.m + uni.g + uni.gg + uni.xg + uni.xxg;
                const tr = document.createElement("tr");
                tr.innerHTML = `
<td>${uni.nome}</td>
<td>${uni.descricao || '-'}</td>
<td>${uni.remetente || '-'}</td>
<td>${uni.tipo || '-'}</td>
<td>${uni.pp}</td>
<td>${uni.p}</td>
<td>${uni.m}</td>
<td>${uni.g}</td>
<td>${uni.gg}</td>
<td>${uni.xg}</td>
<td>${uni.xxg}</td>
<td><strong>${total}</strong></td>
<td>
  <button class="edit-btn" data-index="${index}">Editar</button>
  <button class="delete-btn" data-index="${index}">Excluir</button>
</td>
`;
                tabela.appendChild(tr);
            });

            document.querySelectorAll(".edit-btn").forEach(btn => {
                btn.addEventListener("click", () => editarUniforme(btn.dataset.index));
            });

            document.querySelectorAll(".delete-btn").forEach(btn => {
                btn.addEventListener("click", () => excluirUniforme(btn.dataset.index));
            });
        }

        function atualizarCusto() {
            const precoUnitario = precosUniformes[selectUniforme.value] || 0;
            const totalQuantidade =
                (parseInt(document.getElementById("pp").value) || 0) +
                (parseInt(document.getElementById("p").value) || 0) +
                (parseInt(document.getElementById("m").value) || 0) +
                (parseInt(document.getElementById("g").value) || 0) +
                (parseInt(document.getElementById("gg").value) || 0) +
                (parseInt(document.getElementById("xg").value) || 0) +
                (parseInt(document.getElementById("xxg").value) || 0);

            document.getElementById("custoUnitarioUniforme").value = precoUnitario.toFixed(2);
            document.getElementById("custoTotalUniforme").value = (precoUnitario * totalQuantidade).toFixed(2);
        }

        selectUniforme.addEventListener("change", atualizarCusto);
        document.getElementById("pp").addEventListener("input", atualizarCusto);
        document.getElementById("p").addEventListener("input", atualizarCusto);
        document.getElementById("m").addEventListener("input", atualizarCusto);
        document.getElementById("g").addEventListener("input", atualizarCusto);
        document.getElementById("gg").addEventListener("input", atualizarCusto);
        document.getElementById("xg").addEventListener("input", atualizarCusto);
        document.getElementById("xxg").addEventListener("input", atualizarCusto);

        form.addEventListener("submit", e => {
            e.preventDefault();
            const nome = selectUniforme.value;
            const remetente = document.getElementById("remetenteUniforme").value.trim();
            const tipo = document.getElementById("tipoUniforme").value;

            if (!nome || !remetente || !tipo) {
                alert("Preencha todos os campos obrigatórios.");
                return;
            }

            const totalMovimentado =
                (parseInt(document.getElementById("pp").value) || 0) +
                (parseInt(document.getElementById("p").value) || 0) +
                (parseInt(document.getElementById("m").value) || 0) +
                (parseInt(document.getElementById("g").value) || 0) +
                (parseInt(document.getElementById("gg").value) || 0) +
                (parseInt(document.getElementById("xg").value) || 0) +
                (parseInt(document.getElementById("xxg").value) || 0);

            const custoUnitario = parseFloat(document.getElementById("custoUnitarioUniforme").value) || 0;
            const custoTotal = parseFloat(document.getElementById("custoTotalUniforme").value) || 0;

            const novoUniforme = {
                nome,
                descricao: document.getElementById("descricaoUniforme").value.trim(),
                remetente,
                origin: document.getElementById("originUniforme").value.trim(),
                destination: document.getElementById("destinationUniforme").value.trim(),
                tipo,
                pp: parseInt(document.getElementById("pp").value) || 0,
                p: parseInt(document.getElementById("p").value) || 0,
                m: parseInt(document.getElementById("m").value) || 0,
                g: parseInt(document.getElementById("g").value) || 0,
                gg: parseInt(document.getElementById("gg").value) || 0,
                xg: parseInt(document.getElementById("xg").value) || 0,
                xxg: parseInt(document.getElementById("xxg").value) || 0,
                quantidadeMovimentada: totalMovimentado,
                quantidadeFinal: totalMovimentado,
                custoUnitario,
                custoTotal,
                dateTime: new Date().toLocaleString(),
                timestamp: Date.now()
            };

            if (editIndex >= 0) {
                novoUniforme.timestamp = uniformes[editIndex].timestamp || Date.now();
                uniformes[editIndex] = novoUniforme;
                editIndex = -1;
                btnSalvar.textContent = "Salvar uniforme";
            } else {
                uniformes = [novoUniforme, ...uniformes];
            }

            localStorage.setItem("uniformes", JSON.stringify(uniformes));
            atualizarTabela();
            form.reset();
        });

        function editarUniforme(i) { /* mantém seu código */ }
        function excluirUniforme(i) { /* mantém seu código */ }
        function limparUniformes() { /* mantém seu código */ }

        atualizarTabela();

        const currentPage = window.location.pathname.split("/").pop();
        document.querySelectorAll(".btn-nav").forEach(link => {
            if (link.getAttribute("href") === currentPage) link.classList.add("active");
            else link.classList.remove("active");
        });
    </script>

    <!-- === FIRESTORE INTEGRAÇÃO === -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAF1nvUVl5mJZqc5oPHLeWbxrYX1tOzYuQ",
            authDomain: "estoque-nexta.firebaseapp.com",
            projectId: "estoque-nexta",
            storageBucket: "estoque-nexta.appspot.com",
            messagingSenderId: "1063142163386",
            appId: "1:1063142163386:web:235a6dd699615d999c1383",
            measurementId: "G-H5VKBEWWRW"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const uniformsCol = collection(db, "uniformes");

        // === Observa a coleção em tempo real ===
        onSnapshot(uniformsCol, (snapshot) => {
            snapshot.docs.forEach(doc => {
                const data = doc.data();
                // Atualiza apenas se quiser, mas não mexe no seu código
                // Você pode decidir se quer sincronizar localStorage ou não
                console.log("Uniforme Firestore:", data);
            });
        });

        // === Envio para Firestore ===
        document.getElementById("uniformForm").addEventListener("submit", async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const novoUniforme = {};
            formData.forEach((value, key) => {
                // Converte números
                novoUniforme[key] = isNaN(value) ? value : parseFloat(value);
            });
            novoUniforme.timestamp = serverTimestamp();

            try {
                await addDoc(uniformsCol, novoUniforme);
                console.log("Uniforme enviado para Firestore!");
            } catch (err) {
                console.error(err);
            }

            // Não toca no seu localStorage, tabela ou lógica existente
        });
    </script>

</body>

</html>