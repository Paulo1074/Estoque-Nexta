<!doctype html>
<html lang="pt-BR">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Gerenciador de Estoque</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <button id="toggle-sidebar" class="hamburger">☰</button>

    <div class="app">
        <aside class="sidebar">
            <div class="logo">
                <img src="img/nexta.jpg" alt="Logo Estoque Nexta" class="logo-img">
                <h1>Estoque NEXTA</h1>
            </div>

            <div class="nav">
                <a href="index.html" class="btn-nav active">Movimentações</a>
                <a href="uniforme.html" class="btn-nav">Uniformes</a>
                <a href="Brindes.html" class="btn-nav">Materiais Marketing</a>
                <a href="EstoqueRoupas.html" class="btn-nav">Estoque Roupas</a>
                <a href="EstoqueMkt.html" class="btn-nav">Estoque Materiais</a>
            </div>
        </aside>

        <main class="main">
            <header>
                <h2>Movimentações de estoque</h2>
                <div class="controls">
                    <input id="search" placeholder="Buscar descrição ou produto">
                    <button class="btn danger" id="limpar-dados">Limpar dados</button>
                </div>
            </header>

            <!-- Filtro compacto de data -->
            <div class="filtro-container">
                <label for="filtroData"></label>
                <div class="filtro-inputs">
                    <input type="datetime-local" id="filtroData">
                    <button onclick="filtrarPorData()" class="btn-filtrar">Filtrar</button>
                    <button onclick="limparFiltroData()" class="btn-limpar">Limpar</button>
                </div>
            </div>




            <div class="grid">
                <div class="panel">
                    <div class="panel-header">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Data / Hora</th>
                                        <th>Produto</th>
                                        <th>Destinatário</th>
                                        <th>Tipo</th>
                                        <th>Qnt. mov.</th>
                                        <th>Qnt. final</th>
                                        <th>Custo unit.</th>
                                        <th>Custo total</th>
                                        <th>Descrição</th>
                                        <th>Cidade de Origem</th>
                                        <th>Cidade de Destino</th>
                                    </tr>
                                </thead>
                                <tbody id="moves-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ===== FILTRO POR DATA ===== -->
    <script>
        function filtrarPorData() {
            const input = document.getElementById('filtroData').value;
            if (!input) return;

            const tabela = document.querySelector('table'); // assume que sua tabela é a única ou adicione um id
            const linhas = tabela.querySelectorAll('tbody tr');

            linhas.forEach(linha => {
                const dataCelula = linha.cells[0].innerText; // a primeira coluna é Data / Hora
                const dataTabela = new Date(dataCelula.replace(',', '')); // remove a vírgula para conversão
                const dataFiltro = new Date(input);

                if (dataTabela.toDateString() === dataFiltro.toDateString()) {
                    linha.style.display = ''; // mostra
                } else {
                    linha.style.display = 'none'; // esconde
                }
            });
        }

        function limparFiltroData() {
            const tabela = document.querySelector('table');
            const linhas = tabela.querySelectorAll('tbody tr');
            linhas.forEach(linha => linha.style.display = '');
            document.getElementById('filtroData').value = '';
        }
    </script>

    <!-- ===== SCRIPT ORIGINAL ===== -->
    <script>
        const movesTbody = document.getElementById('moves-tbody');

        function carregarMovimentacoes(localData = true) {
            movesTbody.innerHTML = '';

            let uniformes = JSON.parse(localStorage.getItem('uniformes')) || [];
            let brindes = JSON.parse(localStorage.getItem('brindes')) || [];

            let todosRegistros = [...brindes, ...uniformes];

            if (!localData && window.firestoreData) {
                todosRegistros = [...todosRegistros, ...window.firestoreData];
            }

            todosRegistros.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

            todosRegistros.forEach(item => {
                const tr = document.createElement('tr');
                const tipo = (item.tipo || item.type || '').toLowerCase().trim();
                if (tipo === 'entrada') tr.classList.add('row-entrada');
                else if (tipo === 'saida') tr.classList.add('row-saida');

                const dataStr = item.timestamp ? new Date(item.timestamp).toLocaleString() : item.dateTime || '-';

                tr.innerHTML = `
                <td>${dataStr}</td>
                <td>${item.name || item.nome || '-'}</td>
                <td>${item.sender || item.nomePessoa || item.remetente || '-'}</td>
                <td>${item.type || item.tipo || 'Item'}</td>
                <td>${item.quantidadeMovimentada || item.quantity || 0}</td>
                <td>${item.quantidadeFinal || item.quantity || 0}</td>
                <td>${item.custoUnitario || '-'}</td>
                <td>${item.custoTotal || '-'}</td>
                <td>${item.description || item.descricao || '-'}</td>
                <td>${item.origin || item.origem || '-'}</td>
                <td>${item.destination || item.destino || '-'}</td>
            `;
                movesTbody.appendChild(tr);
            });
        }

        window.addEventListener('storage', event => {
            if (['uniformes', 'brindes'].includes(event.key)) {
                carregarMovimentacoes();
            }
        });

        document.getElementById('limpar-dados').addEventListener('click', () => {
            if (confirm("Deseja realmente remover TODOS os dados de brindes e uniformes?")) {
                localStorage.removeItem('brindes');
                localStorage.removeItem('uniformes');
                alert("Todos os dados foram removidos.");
                carregarMovimentacoes();
            }
        });

        const searchInput = document.getElementById('search');
        searchInput.addEventListener('input', () => {
            const filter = searchInput.value.toLowerCase();
            const rows = movesTbody.getElementsByTagName('tr');
            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                let match = false;
                const searchableIndices = [1, 2, 8, 9, 10];
                for (let index of searchableIndices) {
                    if (cells[index] && cells[index].textContent.toLowerCase().includes(filter)) {
                        match = true;
                        break;
                    }
                }
                rows[i].style.display = match ? '' : 'none';
            }
        });

        const toggleBtn = document.getElementById('toggle-sidebar');
        const sidebar = document.querySelector('.sidebar');
        toggleBtn.addEventListener('click', () => {
            sidebar.classList.toggle('closed');
            toggleBtn.textContent = sidebar.classList.contains('closed') ? '☰' : '✖';
        });

        window.onload = () => carregarMovimentacoes();
    </script>

    <!-- ===== FIREBASE FIRESTORE ===== -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAF1nvUVl5mJZqc5oPHLeWbxrYX1tOzYuQ",
            authDomain: "estoque-nexta.firebaseapp.com",
            projectId: "estoque-nexta",
            storageBucket: "estoque-nexta.appspot.com",
            messagingSenderId: "1063142163386",
            appId: "1:1063142163386:web:235a6dd699615d999c1383",
            measurementId: "G-H5VKBEWWRW"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const uniformesCol = collection(db, "uniformes");
        const brindesCol = collection(db, "brindes");

        // === Atualiza em tempo real ===
        onSnapshot(uniformesCol, snapshot => {
            const data = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
            window.firestoreData = window.firestoreData || [];
            window.firestoreData = [...window.firestoreData.filter(i => !i.id || i.tipo !== 'uniforme'), ...data.map(d => ({ ...d, tipo: 'uniforme' }))];
            carregarMovimentacoes(false);
        });

        onSnapshot(brindesCol, snapshot => {
            const data = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
            window.firestoreData = window.firestoreData || [];
            window.firestoreData = [...window.firestoreData.filter(i => !i.id || i.tipo !== 'brinde'), ...data.map(d => ({ ...d, tipo: 'brinde' }))];
            carregarMovimentacoes(false);
        });
    </script>

</body>

</html>